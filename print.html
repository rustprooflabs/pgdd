<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PgDD: Postgres Data Dictionary Extension</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PgDD: Postgres Data Dictionary Extension</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rustprooflabs/pgdd" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="what-is-pgdd"><a class="header" href="#what-is-pgdd">What is PgDD?</a></h1>
<p>The PostgreSQL Data Dictionary (<code>PgDD</code>) makes it easy to write simple SQL
queries to learn about your database.  PgDD is an in-database solution
providing introspection via standard SQL query syntax. The goal is a
usable data dictionary directly available to all users of a PostgreSQL database.</p>
<p>This extension does not provide anything you cannot get directly from the
internal Postgres catalog tables (e.g. <code>pg_catalog.pg_class</code>).
PgDD makes it <strong>easy</strong> to get to standard, default information most analysts,
developers, and even DBAs need to access from time to time.</p>
<h2 id="compatibility"><a class="header" href="#compatibility">Compatibility</a></h2>
<p>PgDD has been tested to work for PostgreSQL 12 through 16.
This extension is built using the
<a href="https://github.com/pgcentralfoundation/pgrx">pgrx framework</a>.  Postgres
version support is expected to provide 5 years of support, but is ultimately
determined by what <code>pgrx</code> supports.</p>
<p>Installers are provided for a small number of Debian / Ubuntu systems using
the Docker build system documented under <a href="create-installer.html">create-installer.md</a>.</p>
<h2 id="why-not-use-______"><a class="header" href="#why-not-use-______">Why not use <code>______</code>?</a></h2>
<p>Why use PgDD when you could just use <code>psql</code>'s slash commands (e.g. <code>\d</code>)
or directly query the tables/views in <code>pg_catalog</code>?</p>
<p>If those tools provide what you need, great!  PgDD was created to provide
database insights without requiring a specific tool.  It also attempts
to be easy for end users that are <strong>not DBAs</strong>.</p>
<p>See the <a href="quick-start.html">Quick Start</a> and the <a href="query.html">Query</a>
guide for next steps.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<h2 id="install-from-binary"><a class="header" href="#install-from-binary">Install from binary</a></h2>
<p>Binaries for supported Postgres versions are made available for each release.
See the individual release from the <a href="https://github.com/rustprooflabs/pgdd/releases">releases</a>
page for the full list of binaries.
This currently includes binaries for two main LTS supported OS's using the AMD64 architecture.
The latest Ubuntu LTS (currently Jammy, 22.04) and the "PostGIS" image
(currently Debian 11).  The PostGIS image is provided to allow inclusion
in the <a href="https://pgosm-flex.com">PgOSM Flex</a> project's Docker image.</p>
<p>Download and install for PgDD 0.5.2 for Postgres 16 on Ubuntu 22.04.</p>
<pre><code class="language-bash">wget https://github.com/rustprooflabs/pgdd/releases/download/0.5.2/pgdd_0.5.2_jammy_pg16_amd64.deb
sudo dpkg -i ./pgdd_0.5.2_jammy_pg16_amd64.deb
</code></pre>
<p>Create the extension in your database.</p>
<pre><code class="language-sql">CREATE EXTENSION pgdd;
</code></pre>
<h2 id="database-overview"><a class="header" href="#database-overview">Database overview</a></h2>
<pre><code class="language-sql">SELECT * FROM dd.database;
</code></pre>
<pre><code class="language-bash">┌─[ RECORD 1 ]────┬───────────┐
│ oid             │ 2853066   │
│ db_name         │ pgosm_dev │
│ db_size         │ 2325 MB   │
│ schema_count    │ 16        │
│ table_count     │ 107       │
│ size_in_tables  │ 2294 MB   │
│ view_count      │ 27        │
│ size_in_views   │ 11 MB     │
│ extension_count │ 8         │
└─────────────────┴───────────┘
</code></pre>
<h2 id="views"><a class="header" href="#views">Views</a></h2>
<p>Query <code>dd.views</code> within the <code>dd</code> schema (<code>s_name</code>) to see the other PgDD views
included.</p>
<pre><code class="language-sql">SELECT s_name, v_name, description
    FROM dd.views
    WHERE s_name = 'dd'
;
</code></pre>
<pre><code class="language-bash">┌────────┬────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ s_name │       v_name       │                                            description                                             │
╞════════╪════════════════════╪════════════════════════════════════════════════════════════════════════════════════════════════════╡
│ dd     │ tables             │ Data dictionary view: Lists tables, excluding system tables.                                       │
│ dd     │ schemas            │ Data dictionary view: Lists schemas, excluding system schemas.                                     │
│ dd     │ views              │ Data dictionary view: Lists views, excluding system views.                                         │
│ dd     │ columns            │ Data dictionary view: Lists columns, excluding system columns.                                     │
│ dd     │ functions          │ Data dictionary view: Lists functions, excluding system functions.                                 │
│ dd     │ partition_parents  │ Data dictionary view: Lists parent partition tables with aggregate details about child partitions. │
│ dd     │ partition_children │ Data dictionary view: Lists individual partitions (children) of partitioned tables.                │
│ dd     │ database           │ Data dictionary view: Provides basic statistics for the current database.                          │
└────────┴────────────────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="query-pgdd"><a class="header" href="#query-pgdd">Query PgDD</a></h2>
<p>See the <a href="./query.html">Query PgDD</a> section for more examples.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="query-pgdd-1"><a class="header" href="#query-pgdd-1">Query PgDD</a></h1>
<p>Connect to your database using your favorite SQL client. This
could be psql, DBeaver, PgAdmin, or Python code... all you need
is a place to execute SQL code and see the results.</p>
<p>The main interaction with PgDD is through the views in the <code>dd</code> schema.</p>
<h2 id="database-overview-1"><a class="header" href="#database-overview-1">Database overview</a></h2>
<pre><code class="language-sql">SELECT * FROM dd.database;
</code></pre>
<pre><code class="language-bash">┌─[ RECORD 1 ]────┬───────────┐
│ oid             │ 2853066   │
│ db_name         │ pgosm_dev │
│ db_size         │ 2325 MB   │
│ schema_count    │ 16        │
│ table_count     │ 107       │
│ size_in_tables  │ 2294 MB   │
│ view_count      │ 27        │
│ size_in_views   │ 11 MB     │
│ extension_count │ 8         │
└─────────────────┴───────────┘
</code></pre>
<p>The <code>dd.views</code> query can be used to query the views within a database.</p>
<pre><code class="language-sql">SELECT s_name, v_name, description
    FROM dd.views
    WHERE s_name = 'dd'
;
</code></pre>
<pre><code class="language-bash">┌────────┬────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ s_name │       v_name       │                                            description                                             │
╞════════╪════════════════════╪════════════════════════════════════════════════════════════════════════════════════════════════════╡
│ dd     │ tables             │ Data dictionary view: Lists tables, excluding system tables.                                       │
│ dd     │ schemas            │ Data dictionary view: Lists schemas, excluding system schemas.                                     │
│ dd     │ views              │ Data dictionary view: Lists views, excluding system views.                                         │
│ dd     │ columns            │ Data dictionary view: Lists columns, excluding system columns.                                     │
│ dd     │ functions          │ Data dictionary view: Lists functions, excluding system functions.                                 │
│ dd     │ partition_parents  │ Data dictionary view: Lists parent partition tables with aggregate details about child partitions. │
│ dd     │ partition_children │ Data dictionary view: Lists individual partitions (children) of partitioned tables.                │
│ dd     │ database           │ Data dictionary view: Provides basic statistics for the current database.                          │
└────────┴────────────────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<blockquote>
<p>PgDD views wrap around functions with the same name and enforce <code>WHERE NOT system_object</code>. Query the functions to include <code>system_object</code> results.  e.g. <code>SELECT s_name, v_name FROM dd.views() WHERE system_object;</code></p>
</blockquote>
<h3 id="schema"><a class="header" href="#schema">Schema</a></h3>
<p>The highest level of querying provided by <code>pgdd</code> is at the schema level.
This provides counts of tables, views and functions along with the size on disk of the objects within the schema.</p>
<pre><code class="language-sql">SELECT s_name, table_count, view_count, function_count,
        size_plus_indexes, description
    FROM dd.schemas
    WHERE s_name = 'dd';
</code></pre>
<p>Yields results such as this.</p>
<pre><code class="language-bash">┌─[ RECORD 1 ]──────┬────────────────────────────────────────────────────────────────────────────────┐
│ s_name            │ dd                                                                             │
│ table_count       │ 3                                                                              │
│ view_count        │ 5                                                                              │
│ function_count    │ 6                                                                              │
│ size_plus_indexes │ 144 kB                                                                         │
│ description       │ Schema for Data Dictionary objects.  See https://github.com/rustprooflabs/pgdd │
└───────────────────┴────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="tables"><a class="header" href="#tables">Tables</a></h3>
<p>The <code>dd.tables</code> view to examine tables created and populated by <code>pgbench</code>.</p>
<pre><code class="language-sql">SELECT t_name, size_pretty, rows, bytes_per_row
    FROM dd.tables
    WHERE s_name = 'public'
        AND t_name LIKE 'pgbench%'
    ORDER BY size_bytes DESC;
</code></pre>
<pre><code class="language-bash">┌──────────────────┬─────────────┬──────────┬───────────────┐
│      t_name      │ size_pretty │   rows   │ bytes_per_row │
╞══════════════════╪═════════════╪══════════╪═══════════════╡
│ pgbench_accounts │ 1281 MB     │ 10000000 │           134 │
│ pgbench_tellers  │ 80 kB       │     1000 │            82 │
│ pgbench_branches │ 40 kB       │      100 │           410 │
│ pgbench_history  │ 0 bytes     │        0 │             ¤ │
└──────────────────┴─────────────┴──────────┴───────────────┘
</code></pre>
<h3 id="columns"><a class="header" href="#columns">Columns</a></h3>
<pre><code class="language-sql">SELECT source_type, s_name, t_name, c_name, data_type
    FROM dd.columns
    WHERE data_type LIKE 'int%'
;
</code></pre>
<pre><code>┌─────────────┬────────┬─────────────┬────────────────┬───────────┐
│ source_type │ s_name │   t_name    │     c_name     │ data_type │
╞═════════════╪════════╪═════════════╪════════════════╪═══════════╡
│ table       │ dd     │ meta_schema │ meta_schema_id │ int8      │
│ table       │ dd     │ meta_table  │ meta_table_id  │ int8      │
│ table       │ dd     │ meta_column │ meta_column_id │ int8      │
│ view        │ dd     │ schemas     │ table_count    │ int8      │
│ view        │ dd     │ schemas     │ view_count     │ int8      │
│ view        │ dd     │ schemas     │ function_count │ int8      │
│ view        │ dd     │ schemas     │ size_bytes     │ int8      │
│ view        │ dd     │ tables      │ size_bytes     │ int8      │
│ view        │ dd     │ tables      │ rows           │ int8      │
│ view        │ dd     │ tables      │ bytes_per_row  │ int8      │
│ view        │ dd     │ views       │ rows           │ int8      │
│ view        │ dd     │ views       │ size_bytes     │ int8      │
│ view        │ dd     │ columns     │ position       │ int8      │
└─────────────┴────────┴─────────────┴────────────────┴───────────┘
</code></pre>
<h3 id="functions"><a class="header" href="#functions">Functions</a></h3>
<pre><code class="language-sql">SELECT s_name, f_name, argument_data_types, result_data_types
    FROM dd.functions
;
</code></pre>
<h3 id="partitioned-tables"><a class="header" href="#partitioned-tables">Partitioned tables</a></h3>
<p>There are two views, <code>dd.partition_parents</code> and <code>dd.partition_children</code> to provide
partition-focused details.  Will display partitions for both
declarative partitions and inheritance based partitions</p>
<p>With the test data in this project for declarative partitions.</p>
<pre><code class="language-sql">SELECT *
    FROM dd.partition_parents
    WHERE s_name = 'pgdd_test'
;
</code></pre>
<pre><code>┌───────┬───────────┬────────┬────────────────┬────────────┬────────────┬─────────────┬────────────────────┬──────┬────────────────────┬───────────────────────────┬────────────────────┐
│  oid  │  s_name   │ t_name │ partition_type │ partitions │ size_bytes │ size_pretty │ size_per_partition │ rows │ rows_per_partition │ partitions_never_analyzed │ partitions_no_data │
╞═══════╪═══════════╪════════╪════════════════╪════════════╪════════════╪═════════════╪════════════════════╪══════╪════════════════════╪═══════════════════════════╪════════════════════╡
│ 25090 │ pgdd_test │ parent │ declarative    │          3 │      40960 │ 40 kB       │ 13 kB              │   15 │                  5 │                         0 │                  1 │
└───────┴───────────┴────────┴────────────────┴────────────┴────────────┴─────────────┴────────────────────┴──────┴────────────────────┴───────────────────────────┴────────────────────┘
</code></pre>
<p>Details for each child partition, including calculated percentages of the single
partition against the totals for the parent partition.</p>
<pre><code class="language-sql">SELECT *
    FROM dd.partition_children
    WHERE s_name = 'pgdd_test'
;
</code></pre>
<pre><code>┌───────┬───────────┬─────────────┬────────────┬──────────────────┬──────┬────────────┬─────────────┬───────────────────┬───────────────┬───────────────────────────┬────────────────────────────┐
│  oid  │  s_name   │   t_name    │ parent_oid │   parent_name    │ rows │ size_bytes │ size_pretty │ size_plus_indexes │ bytes_per_row │ percent_of_partition_rows │ percent_of_partition_bytes │
╞═══════╪═══════════╪═════════════╪════════════╪══════════════════╪══════╪════════════╪═════════════╪═══════════════════╪═══════════════╪═══════════════════════════╪════════════════════════════╡
│ 25095 │ pgdd_test │ child_0_10  │      25090 │ pgdd_test.parent │    9 │      16384 │ 16 kB       │ 32 kB             │          1820 │                    0.6000 │                     0.4000 │
│ 25109 │ pgdd_test │ child_20_30 │      25090 │ pgdd_test.parent │    0 │       8192 │ 8192 bytes  │ 16 kB             │             ¤ │                    0.0000 │                     0.2000 │
│ 25102 │ pgdd_test │ child_10_20 │      25090 │ pgdd_test.parent │    6 │      16384 │ 16 kB       │ 32 kB             │          2731 │                    0.4000 │                     0.4000 │
└───────┴───────────┴─────────────┴────────────┴──────────────────┴──────┴────────────┴─────────────┴───────────────────┴───────────────┴───────────────────────────┴────────────────────────────┘
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="permissions-for-pgdd"><a class="header" href="#permissions-for-pgdd">Permissions for PgDD</a></h1>
<p>Create Read-only group role to assign to users
that need access to query (read-only) the PgDD objects.</p>
<pre><code class="language-sql">CREATE ROLE dd_read WITH NOLOGIN;
COMMENT ON ROLE dd_read IS 'Group role to grant read-only permissions to PgDD views.';

GRANT USAGE ON SCHEMA dd TO dd_read;
GRANT SELECT ON ALL TABLES IN SCHEMA dd TO dd_read;
ALTER DEFAULT PRIVILEGES IN SCHEMA dd GRANT SELECT ON TABLES TO dd_read;
</code></pre>
<p>Access can now be granted to other users using:</p>
<pre><code class="language-sql">GRANT dd_read TO &lt;your_login_user&gt;;
</code></pre>
<p>For read-write access.</p>
<pre><code class="language-sql">CREATE ROLE dd_readwrite WITH NOLOGIN;
COMMENT ON ROLE dd_readwrite IS 'Group role to grant write permissions to PgDD objects.';

GRANT dd_read TO dd_readwrite;

GRANT INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA dd TO dd_readwrite;
ALTER DEFAULT PRIVILEGES IN SCHEMA dd GRANT INSERT, UPDATE, DELETE ON TABLES TO dd_readwrite;
</code></pre>
<p>This access can be granted using:</p>
<pre><code class="language-sql">GRANT dd_readwrite TO &lt;your_login_user&gt;;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upgrade-pgdd"><a class="header" href="#upgrade-pgdd">Upgrade PgDD</a></h1>
<p>Upgrading PgDD versions currently requires <code>DROP/CREATE</code> to upgrade.
This will not change until
<a href="https://github.com/pgcentralfoundation/pgrx/issues/121">pgrx #121 is resolved</a>.</p>
<p>The first thing to do is check if you have data stored in the <code>dd.meta_*</code>
tables.  Run the following query, if all three (3) rows return <code>row_count = 0</code>
you can simply drop and recreate the extension.</p>
<pre><code class="language-sql">SELECT 'meta_table' AS src, COUNT(*) AS row_count
    FROM dd.meta_table
    WHERE s_name &lt;&gt; 'dd'
UNION
SELECT 'meta_column' AS src, COUNT(*) AS row_count
    FROM dd.meta_column
    WHERE s_name &lt;&gt; 'dd'
UNION
SELECT 'meta_schema' AS src, COUNT(*) AS row_count
    FROM dd.meta_schema
    WHERE s_name &lt;&gt; 'dd'
;
</code></pre>
<p>To drop and recreate the extension, run the following queries.</p>
<pre><code class="language-sql">DROP EXTENSION pgdd;
CREATE EXTENSION pgdd;
</code></pre>
<h2 id="upgrade-with-data-in-dd-tables"><a class="header" href="#upgrade-with-data-in-dd-tables">Upgrade with data in <code>dd</code> tables</a></h2>
<p>If custom attributes are stored in the <code>dd</code> tables you will need to use
<code>pg_dump</code> to export the data and reload after recreating the extension
with pgrx.  If any of the three (3) queries below return a count &gt; 0
this applies to you.</p>
<h2 id="dump-data-from-dd-tables"><a class="header" href="#dump-data-from-dd-tables">Dump data from <code>dd</code> tables</a></h2>
<p>Set the target database name in the <code>$DB_NAME</code> variable for later commands
to use.</p>
<pre><code class="language-bash">export DB_NAME=pgosm_dev
</code></pre>
<p>Run <code>pg_dump</code> against the target database, drop and create the extension,
and reload the data to the <code>dd.meta_*</code> tables.</p>
<pre><code class="language-bash">pg_dump -d $DB_NAME \
    --schema dd --data-only \
    -f ~/tmp/dd_upgrade_data.sql

psql -d $DB_NAME -c "DROP EXTENSION pgdd; CREATE EXTENSION pgdd;"
psql -d $DB_NAME -f ~/tmp/dd_upgrade_data.sql
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-installer"><a class="header" href="#create-installer">Create Installer</a></h1>
<p>This page covers two methods that can be used to build binary installers
for PgDD. This documents how the pre-built binaries are provided for each versions
and explains how end users can extend this to their operating systems and
architectures.</p>
<p>The two methods that can be used to build binaries are the Docker build system
and manually installing and using <code>pgrx</code>.
PgDD's installers are specific to three (3) details:</p>
<ul>
<li>CPU Architecture</li>
<li>Operating System version</li>
<li>Postgres version</li>
</ul>
<h2 id="architecture-supported"><a class="header" href="#architecture-supported">Architecture supported</a></h2>
<p>Project maintainers currently only provide pre-built installers for the AMD architecture.
This matches the hardware easily available.</p>
<h2 id="operating-systems-supported"><a class="header" href="#operating-systems-supported">Operating Systems Supported</a></h2>
<p>Pre-built binaries are provided for recent operating systems, typically
ones in Long Term Support (LTS). Currently building for:</p>
<ul>
<li>Ubuntu 23.04</li>
<li>Ubuntu 22.04</li>
<li>Debian 11 (named PostGIS internally)</li>
</ul>
<h2 id="docker-build-system"><a class="header" href="#docker-build-system">Docker Build System</a></h2>
<p>The Docker build method uses OS specific <code>Dockerfile</code> to provide one binary
installer for each supported Postgres version.  The CPU architecture it is
built for matches the hardware building the installer.
The Docker build system is the best approach to use when the appropriate
<code>Dockerfile</code> already exists.</p>
<blockquote>
<p>The Docker build method was originally based on <a href="https://github.com/zombodb/zombodb">ZomboDB's build system</a>.</p>
</blockquote>
<p>To generate the full suite of binaries change into the <code>./build</code> directory
and run <code>build.sh</code>.  This currently creates 15 total binary installers for
3 different OSs (Postgres 12 - 16).</p>
<pre><code class="language-bash">cd build/
time bash ./build.sh
</code></pre>
<p>Individual installers can be found under <code>./target/artifacts</code>.  A package of
all installers is saved to <code>./build/pgdd-binaries.tar.gz</code>.</p>
<blockquote>
<p>Tagged versions of PgDD include LTS OS binaries with their <a href="https://github.com/rustprooflabs/pgdd/releases">release notes</a>.</p>
</blockquote>
<h3 id="customize-docker-build-system"><a class="header" href="#customize-docker-build-system">Customize Docker Build system</a></h3>
<p>The Docker build system can be adjusted locally to build a binary for
a specific Postgres version and/or specific OS.</p>
<p>The <code>./build/build.sh</code> script has the logic to be adjusted to control this.
The Postgres versions can be  altered manually by commenting out the line
with all versions and uncommenting the line with a specific Postgres version.
The two lines in the script are shown below.</p>
<pre><code class="language-bash">PG_VERS=("pg13" "pg14" "pg15" "pg16" "pg17")
#PG_VERS=("pg16")
</code></pre>
<p>To only build for Postgres on a single OS, add a <code>grep &lt;osname&gt;</code> command to the
loop logic.  The original file that runs for all OSs with Dockerfiles looks like
the following line.</p>
<pre><code class="language-bash">for image in `ls docker/ ` ; do
</code></pre>
<p>To build for only <code>lunar</code> (Ubuntu 23.04) add <code>| grep lunar</code> as shown in the
following example.</p>
<pre><code class="language-bash">for image in `ls docker/ | grep lunar ` ; do
</code></pre>
<h3 id="operating-systems-supported-1"><a class="header" href="#operating-systems-supported-1">Operating Systems supported</a></h3>
<p>Pull requests are welcome for new Dockerfiles to add support for additional operating
systems. These PRs should operate in a similar manner (where possible) to
existing <code>Dockerfile</code> for easiest maintenance.</p>
<hr />
<h2 id="create-binary-installer-wout-docker"><a class="header" href="#create-binary-installer-wout-docker">Create Binary Installer w/out Docker</a></h2>
<p>The following steps walk through creating a package on a typical
Ubuntu based system with Postgres 15.  These manual instructions can be used
when you do not want to use the Docker based build system under <code>./build/</code>.</p>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<p>The main perquisites for PgDD are <code>pgrx</code> and its dependencies.
Install prereqs and ensure PostgreSQL dev tools are installed.</p>
<blockquote>
<p>See the <a href="https://github.com/pgcentralfoundation/pgrx/tree/master/cargo-pgrx">cargo pgrx</a>
documentation for more information on using <code>pgrx</code>.</p>
</blockquote>
<pre><code class="language-bash">sudo apt install postgresql-server-dev-all libreadline-dev zlib1g-dev curl \
    libssl-dev llvm-dev libclang-dev clang \
    graphviz
</code></pre>
<p><a href="https://www.rust-lang.org/tools/install">Install Rust</a> and pgrx.</p>
<pre><code class="language-bash">curl https://sh.rustup.rs -sSf | sh -s -- -y
source $HOME/.cargo/env
</code></pre>
<p>Install <code>cargo-pgrx</code> regularly (see dev steps below for non-standard install).</p>
<pre><code class="language-bash">cargo install --locked cargo-pgrx
</code></pre>
<p>Install <code>cargo-deb</code> used for packaging binaries.</p>
<pre><code class="language-bash">cargo install cargo-deb
</code></pre>
<p>Initialize <code>pgrx</code>.  Need to run this after install AND occasionally to get updates
to Postgres versions or glibc updates.  Not typically required to follow pgrx
developments.</p>
<pre><code class="language-bash">cargo pgrx init
</code></pre>
<p>The <code>fpm</code> step requires the <code>fpm</code> Ruby gem.</p>
<pre><code class="language-bash">sudo apt install ruby-rubygems
sudo gem i fpm
</code></pre>
<p>Of course, the PgDD project itself is required.</p>
<pre><code class="language-bash">mkdir ~/git
cd ~/git
git clone https://github.com/rustprooflabs/pgdd.git
cd ~/git/pgdd
</code></pre>
<h3 id="create-package"><a class="header" href="#create-package">Create package</a></h3>
<blockquote>
<p>Timing note:  <code>cargo pgrx package</code> takes ~ 2 minutes on my main dev machine.</p>
</blockquote>
<pre><code class="language-bash">cargo pgrx package --pg-config /usr/lib/postgresql/15/bin/pg_config
cd target/release/pgdd-pg15/

find ./ -name "*.so" -exec strip {} \;
OUTFILE=pgdd.deb
rm ${OUTFILE} || true
fpm \
  -s dir \
  -t deb -n pgdd \
  -v 0.5.0 \
  --deb-no-default-config-files \
  -p ${OUTFILE} \
  -a amd64 \
  .

sudo dpkg -i --force-overwrite ./pgdd.deb
</code></pre>
<h2 id="pgrx-generate-graphviz"><a class="header" href="#pgrx-generate-graphviz">pgrx Generate graphviz</a></h2>
<pre><code class="language-bash">cargo pgrx schema -d pgdd.dot
dot -Goverlap=prism -Gspline=ortho -Tjpg pgdd.dot &gt; docs/src/pgdd.jpg
</code></pre>
<p><img src="pgdd.jpg" alt="pgrx dependencies for pgdd" /></p>
<h2 id="non-standard-dev"><a class="header" href="#non-standard-dev">Non-standard dev</a></h2>
<p>When working against pgrx installed from a non-tagged branch, install pgrx using:</p>
<pre><code class="language-bash">cargo install --locked --force --git "https://github.com/tcdi/pgrx" \
    --branch "develop" \
    "cargo-pgrx"
</code></pre>
<p>The following command can be used to force pgrx to overwrite the configs it needs to
for various dev related changes.</p>
<p>Clean things out.</p>
<pre><code class="language-bash">cargo clean
</code></pre>
<p>If you're doing the above, you probably should remove the <code>Cargo.lock</code>
file while you're at it.  The more cautious may want to move it aside for a backup.</p>
<pre><code class="language-bash">rm Cargo.lock
</code></pre>
<p>Force build the schema.</p>
<pre><code class="language-bash">cargo pgrx schema -f
</code></pre>
<h2 id="non-standard-in-docker"><a class="header" href="#non-standard-in-docker">Non-standard In Docker</a></h2>
<p>If testing this extension against non-standard pgrx install, update the
Dockerfile to install from the specific branch.</p>
<p>Change</p>
<pre><code class="language-bash">RUN /bin/bash rustup.sh -y \
    &amp;&amp; cargo install --locked cargo-pgrx
</code></pre>
<p>To</p>
<pre><code class="language-bash">RUN /bin/bash rustup.sh -y \
    &amp;&amp; cargo install --locked --force --git "https://github.com/tcdi/pgrx" \
        --branch "develop" \
        "cargo-pgrx"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-notes"><a class="header" href="#developer-notes">Developer Notes</a></h1>
<h2 id="droprecreate-for-upgrade"><a class="header" href="#droprecreate-for-upgrade">Drop/recreate for upgrade</a></h2>
<p>If <a href="https://github.com/pgcentralfoundation/pgrx/issues/121">pgrx #121</a>
is resolved, the need to <code>DROP EXTENSION pgdd; CREATE EXTENSION pgdd;</code> would
go away.  In that case, we need to be aware of
the need to adjust for DDL changes made in <code>src/lib.rs</code> in version-to-version upgrade (e.g. <code>sql/pgdd-0.3.1--0.4.0.sql</code>).</p>
<p>Those scenarios may need review depending on if
<a href="https://github.com/pgcentralfoundation/pgrx/issues/120">pgrx #120</a>
is also resolved or not.</p>
<p>As it stands, <code>drop/create</code> is the upgrade path.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
