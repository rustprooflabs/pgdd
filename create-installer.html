<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Create Installer - PgDD: Postgres Data Dictionary Extension</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PgDD: Postgres Data Dictionary Extension</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rustprooflabs/pgdd" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="create-installer"><a class="header" href="#create-installer">Create Installer</a></h1>
<p>This page covers two methods that can be used to build binary installers
for PgDD. This documents how the pre-built binaries are provided for each versions
and explains how end users can extend this to their operating systems and
architectures.</p>
<p>The two methods that can be used to build binaries are the Docker build system
and manually installing and using <code>pgrx</code>.
PgDD's installers are specific to three (3) details:</p>
<ul>
<li>CPU Architecture</li>
<li>Operating System version</li>
<li>Postgres version</li>
</ul>
<h2 id="architecture-supported"><a class="header" href="#architecture-supported">Architecture supported</a></h2>
<p>Project maintainers currently only provide pre-built installers for the AMD architecture.
This matches the hardware easily available.</p>
<h2 id="operating-systems-supported"><a class="header" href="#operating-systems-supported">Operating Systems Supported</a></h2>
<p>Pre-built binaries are provided for recent operating systems, typically
ones in Long Term Support (LTS). Currently building for:</p>
<ul>
<li>Ubuntu 23.04</li>
<li>Ubuntu 22.04</li>
<li>Debian 11 (named PostGIS internally)</li>
</ul>
<h2 id="docker-build-system"><a class="header" href="#docker-build-system">Docker Build System</a></h2>
<p>The Docker build method uses OS specific <code>Dockerfile</code> to provide one binary
installer for each supported Postgres version.  The CPU architecture it is
built for matches the hardware building the installer.
The Docker build system is the best approach to use when the appropriate
<code>Dockerfile</code> already exists.</p>
<blockquote>
<p>The Docker build method was originally based on <a href="https://github.com/zombodb/zombodb">ZomboDB's build system</a>.</p>
</blockquote>
<p>To generate the full suite of binaries change into the <code>./build</code> directory
and run <code>build.sh</code>.  This currently creates 15 total binary installers for
3 different OSs (Postgres 12 - 16).</p>
<pre><code class="language-bash">cd build/
time bash ./build.sh
</code></pre>
<p>Individual installers can be found under <code>./target/artifacts</code>.  A package of
all installers is saved to <code>./build/pgdd-binaries.tar.gz</code>.</p>
<blockquote>
<p>Tagged versions of PgDD include LTS OS binaries with their <a href="https://github.com/rustprooflabs/pgdd/releases">release notes</a>.</p>
</blockquote>
<h3 id="customize-docker-build-system"><a class="header" href="#customize-docker-build-system">Customize Docker Build system</a></h3>
<p>The Docker build system can be adjusted locally to build a binary for
a specific Postgres version and/or specific OS.</p>
<p>The <code>./build/build.sh</code> script has the logic to be adjusted to control this.
The Postgres versions can be  altered manually by commenting out the line
with all versions and uncommenting the line with a specific Postgres version.
The two lines in the script are shown below.</p>
<pre><code class="language-bash">PG_VERS=("pg13" "pg14" "pg15" "pg16" "pg17")
#PG_VERS=("pg16")
</code></pre>
<p>To only build for Postgres on a single OS, add a <code>grep &lt;osname&gt;</code> command to the
loop logic.  The original file that runs for all OSs with Dockerfiles looks like
the following line.</p>
<pre><code class="language-bash">for image in `ls docker/ ` ; do
</code></pre>
<p>To build for only <code>lunar</code> (Ubuntu 23.04) add <code>| grep lunar</code> as shown in the
following example.</p>
<pre><code class="language-bash">for image in `ls docker/ | grep lunar ` ; do
</code></pre>
<h3 id="operating-systems-supported-1"><a class="header" href="#operating-systems-supported-1">Operating Systems supported</a></h3>
<p>Pull requests are welcome for new Dockerfiles to add support for additional operating
systems. These PRs should operate in a similar manner (where possible) to
existing <code>Dockerfile</code> for easiest maintenance.</p>
<hr />
<h2 id="create-binary-installer-wout-docker"><a class="header" href="#create-binary-installer-wout-docker">Create Binary Installer w/out Docker</a></h2>
<p>The following steps walk through creating a package on a typical
Ubuntu based system with Postgres 15.  These manual instructions can be used
when you do not want to use the Docker based build system under <code>./build/</code>.</p>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<p>The main perquisites for PgDD are <code>pgrx</code> and its dependencies.
Install prereqs and ensure PostgreSQL dev tools are installed.</p>
<blockquote>
<p>See the <a href="https://github.com/pgcentralfoundation/pgrx/tree/master/cargo-pgrx">cargo pgrx</a>
documentation for more information on using <code>pgrx</code>.</p>
</blockquote>
<pre><code class="language-bash">sudo apt install postgresql-server-dev-all libreadline-dev zlib1g-dev curl \
    libssl-dev llvm-dev libclang-dev clang \
    graphviz
</code></pre>
<p><a href="https://www.rust-lang.org/tools/install">Install Rust</a> and pgrx.</p>
<pre><code class="language-bash">curl https://sh.rustup.rs -sSf | sh -s -- -y
source $HOME/.cargo/env
</code></pre>
<p>Install <code>cargo-pgrx</code> regularly (see dev steps below for non-standard install).</p>
<pre><code class="language-bash">cargo install --locked cargo-pgrx
</code></pre>
<p>Install <code>cargo-deb</code> used for packaging binaries.</p>
<pre><code class="language-bash">cargo install cargo-deb
</code></pre>
<p>Initialize <code>pgrx</code>.  Need to run this after install AND occasionally to get updates
to Postgres versions or glibc updates.  Not typically required to follow pgrx
developments.</p>
<pre><code class="language-bash">cargo pgrx init
</code></pre>
<p>The <code>fpm</code> step requires the <code>fpm</code> Ruby gem.</p>
<pre><code class="language-bash">sudo apt install ruby-rubygems
sudo gem i fpm
</code></pre>
<p>Of course, the PgDD project itself is required.</p>
<pre><code class="language-bash">mkdir ~/git
cd ~/git
git clone https://github.com/rustprooflabs/pgdd.git
cd ~/git/pgdd
</code></pre>
<h3 id="create-package"><a class="header" href="#create-package">Create package</a></h3>
<blockquote>
<p>Timing note:  <code>cargo pgrx package</code> takes ~ 2 minutes on my main dev machine.</p>
</blockquote>
<pre><code class="language-bash">cargo pgrx package --pg-config /usr/lib/postgresql/15/bin/pg_config
cd target/release/pgdd-pg15/

find ./ -name "*.so" -exec strip {} \;
OUTFILE=pgdd.deb
rm ${OUTFILE} || true
fpm \
  -s dir \
  -t deb -n pgdd \
  -v 0.5.0 \
  --deb-no-default-config-files \
  -p ${OUTFILE} \
  -a amd64 \
  .

sudo dpkg -i --force-overwrite ./pgdd.deb
</code></pre>
<h2 id="pgrx-generate-graphviz"><a class="header" href="#pgrx-generate-graphviz">pgrx Generate graphviz</a></h2>
<pre><code class="language-bash">cargo pgrx schema -d pgdd.dot
dot -Goverlap=prism -Gspline=ortho -Tjpg pgdd.dot &gt; docs/src/pgdd.jpg
</code></pre>
<p><img src="pgdd.jpg" alt="pgrx dependencies for pgdd" /></p>
<h2 id="non-standard-dev"><a class="header" href="#non-standard-dev">Non-standard dev</a></h2>
<p>When working against pgrx installed from a non-tagged branch, install pgrx using:</p>
<pre><code class="language-bash">cargo install --locked --force --git "https://github.com/tcdi/pgrx" \
    --branch "develop" \
    "cargo-pgrx"
</code></pre>
<p>The following command can be used to force pgrx to overwrite the configs it needs to
for various dev related changes.</p>
<p>Clean things out.</p>
<pre><code class="language-bash">cargo clean
</code></pre>
<p>If you're doing the above, you probably should remove the <code>Cargo.lock</code>
file while you're at it.  The more cautious may want to move it aside for a backup.</p>
<pre><code class="language-bash">rm Cargo.lock
</code></pre>
<p>Force build the schema.</p>
<pre><code class="language-bash">cargo pgrx schema -f
</code></pre>
<h2 id="non-standard-in-docker"><a class="header" href="#non-standard-in-docker">Non-standard In Docker</a></h2>
<p>If testing this extension against non-standard pgrx install, update the
Dockerfile to install from the specific branch.</p>
<p>Change</p>
<pre><code class="language-bash">RUN /bin/bash rustup.sh -y \
    &amp;&amp; cargo install --locked cargo-pgrx
</code></pre>
<p>To</p>
<pre><code class="language-bash">RUN /bin/bash rustup.sh -y \
    &amp;&amp; cargo install --locked --force --git "https://github.com/tcdi/pgrx" \
        --branch "develop" \
        "cargo-pgrx"
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="upgrade.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="developer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="upgrade.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="developer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
